<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Painel do Professor</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
  <div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2>Painel do Professor</h2>
      <div>
        <span id="userNome" class="me-3"></span>
        <button id="logout" class="btn btn-outline-secondary">Logout</button>
      </div>
    </div>

    <div class="card mb-4">
      <div class="card-body">
        <h5>Criar Trabalho</h5>
        <form id="formTarefa">
          <input id="titulo" class="form-control mb-2" placeholder="Título" required>
          <textarea id="descricao" class="form-control mb-2" placeholder="Descrição"></textarea>
          <input id="prazo" type="date" class="form-control mb-2">
          <label class="form-label">Selecionar Alunos (múltipla seleção)</label>
          <select id="alunosSelect" class="form-select mb-2" multiple></select>
          <button class="btn btn-primary" type="submit">Criar Trabalho</button>
        </form>
      </div>
    </div>

    <h5>Trabalhos Criados</h5>
    <div id="listaTarefas" class="list-group"></div>
  </div>

<script>
const API_USERS = "http://localhost:3000/api/users";
const API_TRAB = "http://localhost:3000/api/trabalhos";

const user = JSON.parse(localStorage.getItem("user"));
if (!user || user.tipo !== "professor") {
  alert("Acesso negado. Faça login como professor.");
  window.location.href = "login.html";
} else {
  document.getElementById("userNome").textContent = user.nome;
}

document.getElementById("logout").addEventListener("click", () => {
  localStorage.removeItem("user");
  window.location.href = "login.html";
});

// Carregar lista de alunos para o select
async function loadAlunos() {
  try {
    const res = await fetch(API_USERS);
    const users = await res.json();
    const select = document.getElementById("alunosSelect");
    select.innerHTML = "";
    users.filter(u => u.tipo === "aluno").forEach(a => {
      const opt = document.createElement("option");
      opt.value = a.id;
      opt.textContent = a.nome;
      select.appendChild(opt);
    });
  } catch (err) {
    console.error(err);
    alert("Erro ao carregar alunos");
  }
}

// Criar trabalho
document.getElementById("formTarefa").addEventListener("submit", async (e) => {
  e.preventDefault();
  const titulo = document.getElementById("titulo").value;
  const descricao = document.getElementById("descricao").value;
  const prazo = document.getElementById("prazo").value;
  const alunos = Array.from(document.getElementById("alunosSelect").selectedOptions).map(o => Number(o.value));

  if (!titulo || alunos.length === 0) {
    return alert("Preencha título e selecione pelo menos 1 aluno.");
  }

  try {
    const res = await fetch(API_TRAB, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ titulo, descricao, prazo, alunos, criadoPor: user.id })
    });
    const data = await res.json();
    if (data.error) return alert(data.error || "Erro ao criar trabalho");
    alert("Trabalho criado!");
    document.getElementById("formTarefa").reset();
    loadTarefas();
  } catch (err) {
    console.error(err);
    alert("Erro ao conectar com o servidor");
  }
});

// Carregar trabalhos do professor (usa rota /professor/:id)
async function loadTarefas() {
  try {
    const res = await fetch(`${API_TRAB}/professor/${user.id}`);
    const tarefas = await res.json();
    const container = document.getElementById("listaTarefas");
    container.innerHTML = "";
    tarefas.forEach(t => {
      const div = document.createElement("div");
      div.className = "list-group-item";
      const alunosText = t.alunos ? t.alunos.split(",").join(", ") : "—";
      div.innerHTML = `
        <div class="d-flex w-100 justify-content-between">
          <h5 class="mb-1">${t.titulo}</h5>
          <small>Prazo: ${t.prazo || "N/A"}</small>
        </div>
        <p class="mb-1">${t.descricao || ""}</p>
        <small>Alunos: ${alunosText}</small>
        <div class="mt-2">
          <button class="btn btn-sm btn-outline-primary me-2" data-id="${t.id}" onclick="openEntregas(${t.id})">Ver Entregas</button>
          <button class="btn btn-sm btn-outline-danger" onclick="apagarTrabalho(${t.id})">Apagar</button>
        </div>
      `;
      container.appendChild(div);
    });
  } catch (err) {
    console.error(err);
    alert("Erro ao carregar trabalhos");
  }
}

// Apagar trabalho (chama endpoint DELETE /api/trabalhos/:id) - se existir no backend
async function apagarTrabalho(id) {
  if (!confirm("Apagar este trabalho?")) return;
  try {
    const res = await fetch(`${API_TRAB}/${id}`, { method: "DELETE" });
    const j = await res.json();
    if (j.error) return alert(j.error);
    alert("Trabalho apagado");
    loadTarefas();
  } catch (err) {
    console.error(err);
    alert("Erro ao apagar trabalho");
  }
}

// Abrir página de entregas (nova página) para este trabalho
function openEntregas(trabalhoId) {
  // Passa o id na querystring para a página de entregas/professor_ver_entregas.html
  window.location.href = `professor_ver_entregas.html?trabalhoId=${trabalhoId}`;
}

loadAlunos();
loadTarefas();
</script>
</body>
</html>
